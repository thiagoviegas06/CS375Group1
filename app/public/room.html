<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo</title>
</head>
<body>
  <input id="input">
  <button id="send">Send</button>
  <button id="startVote" style="display: none;">Start Vote</button>
  <div id="usersList"></div>
  
  <div id="votingSection"></div>
  <div id="votingResults"></div>

  <script src="/socket.io.js"></script>

  <script>
    function detectPageRefresh() {
      let navigationType;

      if (performance.getEntriesByType('navigation').length > 0) {
        navigationType = performance.getEntriesByType('navigation')[0].type;
      } else {
        navigationType = performance.navigation.type;
        if (navigationType === 1) {
          navigationType = 'reload';
        } else {
          navigationType = 'navigate';
        }
      }

      if (navigationType === 'reload') {
        window.location.href = '/';
      }
    }
    detectPageRefresh();

    let socket = io();
    let usersList = document.getElementById("usersList");
    let startVoteButton = document.getElementById("startVote");
    let clientUsername = null;
  
    fetch('/get-username')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          clientUsername = data.username;
        }
      });
  
    let pathParts = window.location.pathname.split("/");
    let roomId = pathParts[pathParts.length - 1];
  
    socket.emit('joinRoom', { "roomId": roomId });
  
    socket.on('updateUserList', (userList) => {
      usersList.innerHTML = '';
  
      userList.forEach(user => {
        let listItem = document.createElement('li');
        listItem.textContent = user.username + (user.isPartyLeader ? ' (Leader)' : '');
        usersList.appendChild(listItem);
  
        if (user.isPartyLeader && user.username === clientUsername) {
          startVoteButton.style.display = 'inline-block';
        }
      });
    });
  
    startVoteButton.addEventListener("click", () => {
      socket.emit("startVoting", { roomId: roomId });
    });
  
    socket.on('startVoting', (data) => {
      const restaurants = data.restaurants;
      let currentIndex = 0;
      let userVotes = {};
      let submittedVote = false;
  
      function displayRestaurant(index) {
        socket.emit("submitCurrentVotes", { votes: userVotes })
        if (index >= restaurants.length && !submittedVote) {
          socket.emit('submitVotes', { votes: userVotes });
          document.getElementById('votingSection').innerHTML = "<p>Voting completed. Thank you!</p>";
          submittedVote = true;
          return;
        }

        const restaurant = restaurants[index];
        let votingSection = document.getElementById('votingSection');
        votingSection.innerHTML = '';
  
        let restaurantDiv = document.createElement('div');
  
        let nameElement = document.createElement('h2');
        nameElement.textContent = restaurant.name;
  
        let pictureElement = document.createElement('img');
        pictureElement.src = restaurant.picture;
        pictureElement.alt = restaurant.name;
        pictureElement.style.maxWidth = '400px';
        pictureElement.style.height = 'auto';
  
        let yesButton = document.createElement('button');
        yesButton.textContent = 'Yes';
  
        let noButton = document.createElement('button');
        noButton.textContent = 'No';
  
        yesButton.addEventListener('click', () => {
          currentIndex++;
          userVotes[restaurant.name] = 1;
          displayRestaurant(currentIndex);
        });
  
        noButton.addEventListener('click', () => {
          currentIndex++;
          userVotes[restaurant.name] = -1;
          displayRestaurant(currentIndex);
        });
  
        restaurantDiv.appendChild(nameElement);
        restaurantDiv.appendChild(pictureElement);
        restaurantDiv.appendChild(yesButton);
        restaurantDiv.appendChild(noButton);
  
        votingSection.appendChild(restaurantDiv);
      }
  
      displayRestaurant(currentIndex);
    });

    socket.on('votingResults', (data) => {
      const results = data.results;
      let resultsSection = document.getElementById('votingResults');
      resultsSection.innerHTML = '<h2>Voting Results</h2>';

      let resultsList = document.createElement('ul');

      console.log(data)

      for (const restaurant of Object.values(results)) {
        let listItem = document.createElement('li');
        listItem.textContent = `${restaurant.name}: ${restaurant.score}`;
        resultsList.appendChild(listItem);
      }

      resultsSection.appendChild(resultsList);
    });
  </script>
  
</body>
</html>
